<main>
  <section id="memee">
    <%= render "dashboard/sidebar" %>
    <div id="support" class="main_side">
      <div id="top_header">
        <div class="left_blk">
          <h1>Support</h1>
          <div class="img">
            <img src="<%= asset_path("mobile_icon.svg") %>" alt="">
          </div>
        </div>
        <div class="side">
          <%= render "dashboard/notification_panel" %>
        </div>
      </div>
      <div class="inside">
        <div class="person_side">
          <%= form_for(conversations_path, method: "get", html: { id: 'form' }) do |f| %>
            <div class="dropdown form_blk" id="support_dropDown">
              <button type="button" class="dropdown-toggle site_btn chevron w-100" data-bs-auto-close="outside" data-bs-toggle="dropdown"><%= @header_value.present? ? @header_value : "" %></button>
              <ul class="dropdown-menu w-100">
                <li><button selected type="button" onclick="submission(this.innerText)">Nothing_Happened</button></li>
                <li><button type="button" onclick="submission(this.innerText)">Abuse <span class="dot"></span></button></li>
                <%= f.text_field :subject, hidden: true, id: "subject" %>
                <li><button type="button" onclick="submission(this.innerText)">Payment</button></li>
                <li><button type="button" onclick="submission(this.innerText)">Image <span class="dot"></span></button></li>
                <li><button type="button" onclick="submission(this.innerText)">Profile</button></li>
                <li><button type="button" onclick="submission(this.innerText)">Tournament_Winner <span class="dot"></span></button></li>
                <li><button type="button" onclick="submission(this.innerText)">Coins <span class="dot"></span></button></li>
                <li><button type="button" onclick="submission(this.innerText)">Plagiarism</button></li>
                <li><button type="button" onclick="submission(this.innerText)">Winner_Feedback</button></li>
                <%= f.submit "", hidden: true, id: "form_submit" %>
              </ul>
            </div>
          <% end %>
          </br></br>
          <% conversation_id = "" %>
          <div class="user_list" id="main_user_list">
            <% if @conversation.present? %>
              <% @conversation.each do |conversation| %>
                <% unless conversation.sender.nil? %> 
                  <div class="user_blk" id="clicked" data-conversation-id="<%= conversation.id %>" onclick="open_conversation('<%= conversation.sender&.id %>', '<%= conversation.id %>', '<%= conversation.sender&.username %>', '<%= conversation.sender&.email %>'); get_image('<%= conversation.sender&.email %>'); get_post('<%= conversation.sender&.username %>')">
                    <div class="ico fill round">
                      <img src="<%= conversation.sender&.profile_image&.attached? ? conversation.sender&.profile_image&.blob&.url : asset_path("user.png") %>" alt="">
                    </div>
                    <div class="inr w-100">
                      <div class="title">
                        <h5><%= conversation.sender&.username %></h5>
                        <% if conversation.messages.first.present? %>
                          <% time = Time.now.to_datetime %>
                          <% created = conversation.messages.first.created_at.to_datetime %>
                          <% calculated_time = ((time - created) * 24 * 60).to_i %>
                          <span class="time"><%= distance_of_time_in_words(0, calculated_time.minutes) %></span>
                        <% end %>
                      </div>
                      <div class="txt">
                        <p class="live_message_<%= conversation.id %>"><%= conversation.messages.first.body if conversation.messages.first.present? %></p>
                      </div>
                    </div>
                  </div>
                <%end%>  
              <% end %>
            <% end %>
          </div>
        </div>
        <% if @conversation.present? %>
          <div class="chat_side">
            <div class="top_head_blk">
              <div class="user_blk">
                <div class="ico fill round">
                  <img src="" alt="" id="profile_image" hidden>
                </div>
                <div class="inr">
                  <h5 id="name"></h5>
                  <div id="email"></div>
                </div>
                <div class="r_blk">
                  <div class="status"><input type="radio" name="is_complete" id="is_complete" onchange="completed()">
                    Complete
                  </div>
                  <div class="num_id" id="num_id"></div>
                </div>
              </div>
            </div>
            <%= turbo_stream_from "divs" %>
            <div class="chat_list">
              <div class="chat_blk" id="chat_blk">
              </div>
              <div class="chat_blk memee" id="admin_div">
              </div>
            </div>
            <div id="file-preview" style="display: none; position: relative; display: inline-block;">
              <!-- Cross icon to remove the preview -->
              <div id="remove-preview" style="position: absolute; top: 5px; right: 5px; cursor: pointer; display: none; z-index: 10;">
                  <img src="<%= asset_path('cross-icon.svg') %>" alt="Remove" style="width: 20px; height: 20px;">
              </div>

              <!-- Blur background behind the preview content -->
              <div id="blur-background" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1;"></div>

              <!-- Preview content (image or video will go here) -->
              <div id="preview-content" style="position: relative; z-index: 5;"></div>
          </div>

            <%= form_with do |form| %>
              <div class="form_inside">
                <%= form.file_field :message_images, id: "document-btn", direct_upload: true, multiple: true, hidden: true, accept: 'image/png, image/jpeg, image/jpg, video/mp4' %>
                <label for="document-btn" class="ico_btn label"><img src="<%= asset_path("icon-clip.svg") %>" alt=""></label>
                <%= form.file_field :message_images, id: "file-btn", direct_upload: true, multiple: true, hidden: true, accept: 'image/png, image/jpeg, image/jpg, video/mp4' %>
                <label for="file-btn" class="ico_btn label" id="label_btn"><img src="<%= asset_path("icon-image.svg") %>" alt=""></label>
                <input type="text" class="input" name="body" id="body" placeholder="Write your message here" required>
                <input name="conversation_id" id="conversation_id" hidden></input>
                <input name="receiver_id" id="receiver_id" hidden></input>
                <input name="user_id" id="user_id" hidden></input>
                <input name="subject" id="subject" hidden></input>
                <input name="admin_user_id" id="admin_id" hidden></input>
                <button type="submit" class="send_btn"><img src="<%= asset_path("icon-send.svg") %>" alt=""></button>
              </div>
            <% end %>

          </div>
        <% else %>
          <h4 class="w-100 d-flex justify-content-center align-items-center">No Support Ticket Found</h4>
        <% end %>
      </div>
    </div>
  </section>
</main>

<script>

/**
 * Open the conversation using coversationId on Notification Click
 * */
    const fileInput = document.getElementById('file-btn');
    const previewContainer = document.getElementById('file-preview');
    const previewContent = document.getElementById('preview-content');
    const removePreview = document.getElementById('remove-preview');
    const blurBackground = document.getElementById('blur-background');
    

    // Handle file selection and preview display
    $(document).on('change', '#file-btn', function(event) {
      console.log("file changing");
      
        const files = event.target.files;

        // Clear previous previews
        previewContent.innerHTML = '';

        // Loop through each selected file and display a preview
        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            // If it's an image, show image preview
            if (file.type.startsWith('image')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '200px';  // Limit size for preview
                    img.style.maxHeight = '200px';
                    previewContent.appendChild(img);
                };
                reader.readAsDataURL(file);
            }

            // If it's a video, show video preview
            else if (file.type.startsWith('video')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.style.maxWidth = '200px';  // Limit size for preview
                previewContent.appendChild(video);
            }
        }

        // Show the preview container and cross icon
        previewContainer.style.display = 'inline-block';
        removePreview.style.display = 'block';
    });

    // Add event listener to the remove preview button (cross icon)
    removePreview.addEventListener('click', function() {
        // Clear the preview content
        previewContent.innerHTML = '';
        console.log("removing image");
        fileInput.value = ''

        // Hide the preview container
        previewContainer.style.display = 'none';

        // Hide the cross icon
        removePreview.style.display = 'none';
    });

    $('form').on('submit', function () {
        // Hide the file preview container when the form is submitted
        
        previewContent.innerHTML = '';

        // Hide the preview container
        previewContainer.style.display = 'none';

        // Hide the cross icon
        removePreview.style.display = 'none';
    });


  $(document).ready(function() {
    

    // Add click event to user blocks
    $(".user_list").on('click', '.user_blk', function() {
      $(".user_list .user_blk.active").removeClass("active");
      $(this).addClass("active");
    });

    $(".chat_list").scrollTop($(".chat_list").prop("scrollHeight"));

    $("#clicked").click(function() {
      $(this).addClass("active");
    });

    // Check if conversation ID is present in URL
    const urlParams = new URLSearchParams(window.location.search);
    const conversationId = urlParams.get('conversationId');
    console.log("Conversation Id on supoort page ====", conversationId);
      if (conversationId) {
      // Filter conversation based on conversationId
      const conversation = <%= @conversation.to_json.html_safe %>.find(conv => conv.id == conversationId);
      console.log('Conversation:', conversation);
      
      if (conversationId) {
        const conversation = <%= @conversation.to_json.html_safe %>.find(conv => conv.id == conversationId);
        console.log('Conversation:', conversation); // Log the conversation object
        
        if (conversation) {
          fetch(`api/v1/users/get_sender_details/${conversation?.sender_id}`)
          .then(response => response.json())
          .then(data => {
            const { username, email } = data;
            console.log("response  === ", username , email);
            open_conversation(conversation?.sender_id, conversationId, username, email);
            get_image(email);
            get_post(username);
            const conversationElement = $(`.user_list .user_blk[data-conversation-id="${conversationId}"]`);
      
        // Check if element exists
            if (conversationElement.length > 0) {
              conversationElement.addClass("active");

              // Remove active class from other conversation blocks
              $(".user_list .user_blk").not(conversationElement).removeClass("active");

              // Scroll only the sidebar into view (not the whole page)
              const sidebar = $(".user_list"); // The sidebar container

              sidebar.animate({
                scrollTop: conversationElement.offset().top - sidebar.offset().top + sidebar.scrollTop() - 100
              }, 'smooth');
            } else {
              console.error("Conversation element not found");
            }
              // Highlight the opened chat block
              //  $(`.user_list .user_blk[data-conversation-id="${conversationId}"]`).addClass("active");
        })
      .catch(error => {
        console.error('Error fetching sender details:', error);
      });
        } else {
          console.error('Conversation or sender not found');
        }
      }
    }

  });


    $("#clicked").click()
    $("#clicked").addClass("active")
    $(".user_list").on('click', '.user_blk', function () {
        $(".user_list .user_blk.active").removeClass("active");
        $(this).addClass("active");
    });

    $(window).load(function () {
        $(".chat_list").scrollTop($(".chat_list").prop("scrollHeight"));
    })

    function open_conversation(sender_id, conversation_id, name, email) {
        var live_message_id = ".live_message_" + conversation_id
        $(live_message_id).attr("id", "under_message_" + conversation_id)
        $('#chat_list').data('id', conversation_id);
        $(".chat_side .chat_list").attr("id", "chat_list_" + conversation_id)
        $("#clicked").removeClass("active")
        document.getElementById("conversation_id").value = conversation_id
        document.getElementById("admin_id").value = '<%= current_admin_user.id %>'
        document.getElementById("receiver_id").value = sender_id
        document.getElementById("user_id").value = sender_id
        var admin_id = '<%= current_admin_user.id %>'
        $(".chat_list").empty()
        $.ajax({
            type: "GET",
            url: "conversation",
            data: {conversation_id: conversation_id, email: email, admin_id: admin_id},
            success: function (response) {
                var messages = response.messages
                if (response.conversation.status === "Closed") {
                    document.getElementById("is_complete").checked = true
                } else {
                    document.getElementById("is_complete").checked = false
                }
                document.getElementById("name").innerHTML = name
                document.getElementById("email").innerHTML = email
                var images = response.images
                var i = -1;
                messages.forEach(function (message) {
                    i++;
                    message_design(message, images[i], response.user_image, response.admin_image)
                })
            }
        })
    }

    function get_image(email) {
        $.ajax({
            type: "GET",
            url: "conversation-image",
            data: {email: email},
            success: function (response) {
                document.getElementById("profile_image").removeAttribute("hidden")
                document.getElementById("profile_image").src = response.image
            }
        })
    }

    function get_post(name) {

    }

   let isUserScrolling = false; // Flag to detect manual scroll
   let lastScrollTop = 0;  

    // Function to scroll to the last message
    function scrollToLastMessage() {
        const chatList = $(".chat_list");
        const lastMessage = $(".chat_list .chat_blk:last-child");

        if (lastMessage.length > 0) {
            chatList.animate({
                scrollTop: lastMessage[0].offsetTop + lastMessage.outerHeight() - chatList.height()
            }, "fast", function() {
                isUserScrolling = false; // Reset flag after reaching bottom
            });
        }
    }

    // Debounce function to limit scroll events
    function debounce(func, wait) {
        let timeout;
        return function() {
            clearTimeout(timeout);
            timeout = setTimeout(func, wait);
        };
    }

    // Observer to handle auto-scroll when a new message is added
    let observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (!entry.isIntersecting && !isUserScrolling) {
                scrollToLastMessage();
            }
        });
    }, { threshold: 1.0 }); // Set threshold to 1 to observe full visibility

  function message_design(message, images, user_image, admin_image) {
    var chat_list_id = document.getElementsByClassName("chat_list")[0].id;
    var topDiv = document.getElementById(chat_list_id);
    document.getElementById("num_id").innerHTML = message.message_ticket;
    var message_div = document.createElement("div");

    if (message.sender_id !== null) {
        message_div.setAttribute('class', 'chat_blk');
    } else {
        message_div.setAttribute('class', 'chat_blk memee');
    }

    var div = document.createElement("div");
    div.setAttribute('class', 'ico fill round');
    var img = document.createElement("img");

    img.src = message.sender_id !== null ? user_image : admin_image;
    img.style.borderRadius = "50%";
    img.style.objectFit = "cover";
    div.appendChild(img);

    var div1 = document.createElement("div");
    if (images[0] === "") {
        div1.setAttribute('class', 'txt');
        var p = document.createElement("p");
        if (message.sender_id !== null) {
            p.setAttribute("class", "bottom");
        }
        div1.appendChild(p.appendChild(document.createTextNode(message.body)));
    } else {
        div1.setAttribute('class', 'txt w-50 h-50');
        var image_div = document.createElement("div");

        images.forEach((image) => {
            if (image.type === 'video') {
                var video = document.createElement("video");
                video.setAttribute("controls", true);
                video.setAttribute("class", 'w-100 h-100');
                var videoSource = document.createElement("source");
                videoSource.setAttribute("src", image.url);
                videoSource.setAttribute("type", "video/mp4");
                video.append(videoSource);
                image_div.append(video);
            } else {
                var message_img = document.createElement("img");
                message_img.setAttribute('class', 'w-40 h-40 float-end mb-1');
                message_img.src = image.url;

                // Add load event to ensure scrolling after image loads
                message_img.onload = scrollToLastMessage;
                image_div.appendChild(message_img);
            }
        });

        div1.appendChild(image_div);
        var p_div = document.createElement("div");
        var p = document.createElement("p");
        if (message.sender_id === null) {
            p_div.setAttribute("class", "float-end");
        }
        p_div.appendChild(p.appendChild(document.createTextNode(message.body)));
        div1.appendChild(p_div);
    }

    message_div.appendChild(div);
    message_div.appendChild(div1);
    topDiv.appendChild(message_div);

   const lastMessage = $(".chat_list .chat_blk:last-child");
    if (lastMessage.length > 0) {
        observer.disconnect(); // Disconnect the observer to avoid repetitive calls
        observer.observe(lastMessage[0]); // Observe the last message
    }

    // Scroll to the last message only if the user is not scrolling up
    if (!isUserScrolling) {
        console.log("User not scrolling, scrolling to the last message...");
        scrollToLastMessage();
    } else {
        console.log("User scrolling, avoiding auto-scroll...");
    }
}

// Helper function to scroll to the bottom of the chat
    function scrollToLastMessage() {
        $(".chat_list").animate({ scrollTop: $(".chat_list").prop("scrollHeight") }, "fast");
    }

  $(".chat_list").on("scroll", debounce(function () {
      const chatList = $(this);
      const scrollTop = chatList.scrollTop();

      // Determine if the user is scrolling up
      if (scrollTop < lastScrollTop) {
          console.log("Scrolling up...");
          isUserScrolling = true;  // User is scrolling up
      } else {
          console.log("Scrolling down...");
          isUserScrolling = true;  // User is scrolling down
      }

      lastScrollTop = scrollTop;  // Update last scroll position

  }, 50));
// Prevent page scroll when the chat_list can scroll
  $(".chat_list").on("wheel", function (e) {
      const chatList = this;
      const atTop = chatList.scrollTop === 0;
      const atBottom = chatList.scrollTop + chatList.clientHeight === chatList.scrollHeight;

      if ((e.originalEvent.deltaY < 0 && atTop) || (e.originalEvent.deltaY > 0 && atBottom)) {
          // Prevent scrolling the page when at top or bottom of chat_list
          e.preventDefault();
      }
  });


    // function message_design(message, images, user_image, admin_image) {
    //     var chat_list_id = document.getElementsByClassName("chat_list")[0].id
    //     var topDiv = document.getElementById(chat_list_id)
    //     var admindiv = document.getElementById("admin_div")
    //     if (message.sender_id !== null) {
    //         document.getElementById("num_id").innerHTML = message.message_ticket
    //         var message_div = document.createElement("div")
    //         message_div.setAttribute('class', 'chat_blk')
    //         var div = document.createElement("div")
    //         div.setAttribute('class', 'ico fill round')
    //         var img = document.createElement("img");
    //         img.src = user_image
    //         div.appendChild(img)
    //         var div1 = document.createElement("div")
    //         if (images[0] === "") {
    //             div1.setAttribute('class', 'txt')
    //             var p = document.createElement("p")
    //             p.setAttribute("class", "bottom")
    //             div1.appendChild(p.appendChild(document.createTextNode(message.body)))
    //         } else {
    //             div1.setAttribute('class', 'txt w-50 h-50')
    //             if (images.length === 1) {
    //                 if (images[0].split('.').pop().toLowerCase() === 'mp4'){
    //                     var image_div = document.createElement("div")
    //                     image_div.setAttribute('class', 'w-40 h-40 float-end')
    //                     var videoSource = document.createElement("source")
    //                     videoSource.setAttribute("src", `${images[0]}`)
    //                     videoSource.setAttribute("type", "video/mp4");
    //                     var video = document.createElement('video')
    //                     video.setAttribute("controls", true)
    //                     video.setAttribute('class', 'w-100 h-100');
    //                     video.append(videoSource)
    //                     image_div.append(video);
    //                 }else{
    //                     var image_div = document.createElement("div")
    //                     var message_img = document.createElement("img");
    //                     message_img.setAttribute('class', 'w-40 h-40 float-end')
    //                     message_img.src = images
    //                     image_div.appendChild(message_img)
    //                 }
    //             } else {
    //                 var image_div = document.createElement("div")
    //                 images.forEach(function (image) {
    //                     if(image.split('.').pop().toLowerCase() === 'mp4'){
    //                         image_div.setAttribute('class', 'w-40 h-40 float-end')
    //                         var videoSource = document.createElement("source")
    //                         videoSource.setAttribute("src", `${image}`)
    //                         videoSource.setAttribute("type", "video/mp4");
    //                         var video = document.createElement('video')
    //                         video.setAttribute("controls", true)
    //                         video.setAttribute('class', 'w-100 h-100');
    //                         video.append(videoSource)
    //                         image_div.appendChild(video);
    //                     }else{
    //                         var message_img = document.createElement("img");
    //                         message_img.setAttribute('class', 'w-40 h-40 float-end mb-1')
    //                         message_img.src = image
    //                         image_div.appendChild(message_img)
    //                     }
    //                 })
    //             }
    //             div1.appendChild(image_div)
    //             var p_div = document.createElement("div")
    //             var p = document.createElement("p")
    //             p_div.appendChild(p.appendChild(document.createTextNode(message.body)))
    //             div1.appendChild(p_div)
    //         }
    //         message_div.appendChild(div)
    //         message_div.appendChild(div1)
    //         topDiv.appendChild(message_div)
    //     } else {
    //         var message_div = document.createElement("div")
    //         message_div.setAttribute('class', 'chat_blk memee')
    //         var div = document.createElement("div")
    //         div.setAttribute('class', 'ico fill round')
    //         var img = document.createElement("img");
    //         img.setAttribute("style", "border-radius: 50%; object-fit: cover")
    //         img.src = admin_image
    //         div.appendChild(img)
    //         var div1 = document.createElement("div")
    //         if (images[0] === "") {
    //             div1.setAttribute('class', 'txt')
    //             var p = document.createElement("p")
    //             div1.appendChild(p.appendChild(document.createTextNode(message.body)))
    //         } else {
    //             div1.setAttribute('class', 'txt w-50 h-50')
    //             if (images.length === 1) {
    //                 if(images[0].split('.').pop().toLowerCase() === 'mp4'){
    //                     var image_div = document.createElement("div")
    //                     image_div.setAttribute('class', 'w-40 h-40 float-end')
    //                     var videoSource = document.createElement("source")
    //                     videoSource.setAttribute("src", `${images[0]}`)
    //                     videoSource.setAttribute("type", "video/mp4");
    //                     var video = document.createElement('video')
    //                     video.setAttribute("controls", true)
    //                     video.setAttribute('class', 'w-100 h-100');
    //                     video.append(videoSource)
    //                     image_div.append(video);
    //                 }else{
    //                     var image_div = document.createElement("div")
    //                     var message_img = document.createElement("img");
    //                     message_img.setAttribute('class', 'w-40 h-40 float-end')
    //                     message_img.src = images
    //                     image_div.appendChild(message_img)
    //                 }
    //             } else {
    //                 var image_div = document.createElement("div")
    //                 images.forEach(function (image) {
    //                     if(image.split('.').pop().toLowerCase() === 'mp4'){
    //                         image_div.setAttribute('class', 'w-40 h-40 float-end')
    //                         var videoSource = document.createElement("source")
    //                         videoSource.setAttribute("src", `${image}`)
    //                         videoSource.setAttribute("type", "video/mp4");
    //                         var video = document.createElement('video')
    //                         video.setAttribute("controls", true)
    //                         video.setAttribute('class', 'w-100 h-100');
    //                         video.append(videoSource)
    //                         image_div.append(video);
    //                     }else{
    //                         var message_img = document.createElement("img");
    //                         message_img.setAttribute('class', 'w-40 h-40 float-end mb-1')
    //                         message_img.src = image
    //                         image_div.appendChild(message_img)
    //                     }
    //                 })
    //             }
    //             div1.appendChild(image_div)
    //             var p_div = document.createElement("div")
    //             var p = document.createElement("p")
    //             p_div.setAttribute("class", "float-end")
    //             p_div.appendChild(p.appendChild(document.createTextNode(message.body)))
    //             div1.appendChild(p_div)
    //         }
    //         message_div.appendChild(div)
    //         message_div.appendChild(div1)
    //         topDiv.appendChild(message_div)
    //     }
    //     $(".chat_list").scrollTop($(".chat_list").prop("scrollHeight"));
    // }

    function completed() {
        var message_ticket = document.getElementById("num_id").innerHTML
        $.ajax({
            type: "GET",
            url: "completed",
            data: {message_ticket: message_ticket},
            success: function (response) {
                document.getElementById("profile_image").removeAttribute("hidden")
                document.getElementById("profile_image").src = response.image
            }
        })
    }

    function submission(subject) {
        $("#subject")[0].value = subject
        $("#form_submit").click()
    }

    $(document).ready(function () {
        $("#support_dropDown .dropdown-toggle").on("click", function () {
            if ($("#overlay").hasClass("show")) {
                $("#overlay").removeClass("show")
                $("#support .bell_btn").removeClass("hide_bell_btn")
            } else {
                $("#overlay").addClass("show")
                $("#support .bell_btn").addClass("hide_bell_btn")
            }
        })
        $("#overlay").on("click", function () {
            $("#overlay").removeClass("show")
            $("#support .bell_btn").removeClass("hide_bell_btn")
        })
    })
</script>